<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel - Dick Stein Practice Cup</title>
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
    <div class="site-container" style="max-width: 600px; margin: 40px auto;">
        <main>
            <h1>Admin Panel</h1>

            <div class="content-card">
                <h2>Add a New Player</h2>
                <form id="add-player-form" method="POST">
                    <p><label>Player's Name: <input type="text" name="name" required /></label></p>
                    <p><label>Player's Photo: <input type="file" name="photo" accept="image/jpeg, image/png" required /></label></p>
                    <p><label>Player Bio/Description: <textarea name="description" rows="4" required></textarea></label></p>
                    <p><button type="submit">Add Player</button></p>
                </form>
                <div id="add-player-form-status" class="form-status"></div>
            </div>

            <div class="content-card">
                <h2>Update Current Champion</h2>
                <form id="update-champion-form" method="POST">
                    <p><label>Winner's Name:
                        <select name="name" id="player-select" required>
                            <option value="">Loading players...</option>
                        </select>
                    </label></p>
                    <p><label>Week Of: <input type="text" name="week" required /></label></p>
                    <p><label>Series Score: <input type="number" name="series" required /></label></p>
                    <p><button type="submit">Submit New Champion</button></p>
                </form>
                <div id="champion-form-status" class="form-status"></div>
            </div>

            <div class="content-card">
                <h2>Upload Seasonal Results</h2>
                <form id="upload-season-form" method="POST">
                     <p><label>Season Name (e.g., "late-2025"): <input type="text" name="season_name" required pattern="^(early|late)-\d{4}$" title="Format must be 'early-YYYY' or 'late-YYYY'"></label></p>
                    <p><label>Season Excel File (.xlsx): <input type="file" name="sheet" accept=".xlsx" required /></label></p>
                    <p><button type="submit">Upload Season File</button></p>
                </form>
                <div id="season-form-status" class="form-status"></div>
            </div>
            
            <div class="content-card">
                <h2>Delete a Season (Irreversible)</h2>
                <form id="delete-season-form" method="POST">
                    <p><label>Season to Delete:
                        <select name="season_name" id="season-select" required>
                            <option value="">Loading seasons...</option>
                        </select>
                    </label></p>
                    <p><button type="submit" style="background-color: #d9534f; border-color: #d43f3a; color: white;">Delete This Season Forever</button></p>
                </form>
                <div id="delete-season-form-status" class="form-status"></div>
            </div>
        </main>
    </div>

    <script>
      // --- Data Loading ---
      async function loadPlayers() {
        try {
            const response = await fetch('/.netlify/functions/get-players');
            if (!response.ok) throw new Error('Failed to load players');
            const players = await response.json();
            const playerSelect = document.getElementById('player-select');
            playerSelect.innerHTML = '<option value="">Select a player</option>';
            players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.name;
                option.textContent = player.name;
                playerSelect.appendChild(option);
            });
        } catch (error) {
            console.error(error);
        }
      }

      async function loadSeasons() {
        try {
            const response = await fetch('/.netlify/functions/get-seasons');
            if (!response.ok) throw new Error('Failed to load seasons');
            const seasons = await response.json();
            const seasonSelect = document.getElementById('season-select');
            seasonSelect.innerHTML = '<option value="">Select a season</option>';
            seasons.forEach(season => {
                const option = document.createElement('option');
                option.value = season;
                option.textContent = season;
                seasonSelect.appendChild(option);
            });
        } catch (error) {
            console.error(error);
        }
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        loadPlayers();
        loadSeasons();
      });

      // --- Form Submission Logic ---
      async function handleFormSubmit(event, statusDiv, endpoint) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        let body;
        let headers = {};

        if (form.querySelector('input[type="file"]')) {
            body = formData;
        } else {
            const data = Object.fromEntries(formData.entries());
            body = JSON.stringify(data);
            headers['Content-Type'] = 'application/json';
        }
        
        statusDiv.textContent = 'Submitting, please wait...';
        statusDiv.style.color = 'blue';

        try {
            const response = await fetch(endpoint, { method: 'POST', body, headers });
            if (!response.ok) {
                throw new Error(`Server responded with ${response.status}: ${await response.text()}`);
            }
            window.location.href = '/thank-you/';
        } catch (error) {
            console.error('Submission failed:', error);
            statusDiv.textContent = `Error: ${error.message}`;
            statusDiv.style.color = 'red';
        }
      }

      document.getElementById('add-player-form').addEventListener('submit', e => {
        handleFormSubmit(e, document.getElementById('add-player-form-status'), '/.netlify/functions/add-player');
      });

      document.getElementById('update-champion-form').addEventListener('submit', e => {
        handleFormSubmit(e, document.getElementById('champion-form-status'), '/.netlify/functions/update-champion');
      });

      document.getElementById('upload-season-form').addEventListener('submit', e => {
        handleFormSubmit(e, document.getElementById('season-form-status'), '/.netlify/functions/upload-season');
      });

      document.getElementById('delete-season-form').addEventListener('submit', e => {
          if (confirm('Are you absolutely sure you want to permanently delete this season and all its data? This action cannot be undone.')) {
              handleFormSubmit(e, document.getElementById('delete-season-form-status'), '/.netlify/functions/delete-season');
          } else {
              e.preventDefault();
          }
      });
    </script>
</body>
</html>
